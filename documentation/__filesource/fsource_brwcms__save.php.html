<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  <html xmlns="http://www.w3.org/1999/xhtml">
		<head>
			<!-- template designed by Marco Von Ballmoos  -->
			<title>File Source for save.php</title>
			<link rel="stylesheet" href="../media/stylesheet.css" />
											</head>
		<body>
						<h1>Source for file save.php</h1>
<p>Documentation is available at <a href="../brwcms/_code_save_php.html">save.php</a></p>
<div class="src-code">
<pre><ol><li><a name="a1"></a><span class="src-php">&lt;?php</span></li>
<li><a name="a2"></a><span class="src-inc">include</span><span class="src-sym">( </span><span class="src-str">'configuration.php' </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a3"></a>require <span class="src-sym">( </span><span class="src-str">'../admin/coreclass.php' </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a4"></a><a href="http://www.php.net/session_start">session_start</a><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a5"></a><span class="src-comm">// if user is not login..redirect him to login page </span></li>
<li><a name="a6"></a><span class="src-key">if </span><span class="src-sym">( </span><span class="src-sym">!</span>isset<span class="src-sym">(</span><span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'login'</span><span class="src-sym">]</span><span class="src-sym">)) </span><span class="src-sym">{ </span></li>
<li><a name="a7"></a>    <a href="http://www.php.net/header">header</a><span class="src-sym">(</span><span class="src-str">'Location: ../admin/login.php'</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a8"></a><span class="src-sym">}</span></li>
<li><a name="a9"></a><span class="src-key">if </span><span class="src-sym">(</span>isset<span class="src-sym">(</span><span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'login'</span><span class="src-sym">]</span><span class="src-sym">)) </span><span class="src-sym">{</span></li>
<li><a name="a10"></a>    <span class="src-var">$userID </span>= <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'userID'</span><span class="src-sym">]</span><span class="src-sym">;</span></li>
<li><a name="a11"></a>    <span class="src-var">$usertype </span>= <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'usertype'</span><span class="src-sym">]</span><span class="src-sym">;</span></li>
<li><a name="a12"></a><span class="src-sym">}</span></li>
<li><a name="a13"></a><span class="src-var">$categoryID     </span>= <span class="src-var">$_POST</span><span class="src-sym">[</span><span class="src-str">'category'</span><span class="src-sym">]</span><span class="src-sym">;</span></li>
<li><a name="a14"></a><span class="src-var">$created         </span>= <span class="src-var">$_POST</span><span class="src-sym">[</span><span class="src-str">'created'</span><span class="src-sym">]</span><span class="src-sym">;</span></li>
<li><a name="a15"></a><span class="src-var">$article_title     </span>= <span class="src-var">$_POST</span><span class="src-sym">[</span><span class="src-str">'title'</span><span class="src-sym">]</span><span class="src-sym">;</span></li>
<li><a name="a16"></a><span class="src-var">$article_body     </span>= <span class="src-var">$_POST</span><span class="src-sym">[</span><span class="src-str">'elm1'</span><span class="src-sym">]</span><span class="src-sym">;</span></li>
<li><a name="a17"></a><span class="src-var">$stage             </span>= <span class="src-var">$_POST</span><span class="src-sym">[</span><span class="src-str">'stage'</span><span class="src-sym">]</span><span class="src-sym">;</span></li>
<li><a name="a18"></a><span class="src-var">$frontpage         </span>= <span class="src-var">$_POST</span><span class="src-sym">[</span><span class="src-str">'frontpage'</span><span class="src-sym">]</span><span class="src-sym">;</span></li>
<li><a name="a19"></a><span class="src-var">$keywords         </span>= <span class="src-var">$_POST</span><span class="src-sym">[</span><span class="src-str">'keywords'</span><span class="src-sym">]</span><span class="src-sym">;</span></li>
<li><a name="a20"></a><span class="src-var">$articletask     </span>= <span class="src-var">$_POST</span><span class="src-sym">[</span><span class="src-str">'articletask'</span><span class="src-sym">]</span><span class="src-sym">;</span></li>
<li><a name="a21"></a>&nbsp;</li>
<li><a name="a22"></a><span class="src-key">if </span><span class="src-sym">(</span><a href="http://www.php.net/trim">trim</a><span class="src-sym">(</span><span class="src-var">$article_body</span><span class="src-sym">) </span>== <span class="src-str">&quot;&quot; </span><span class="src-sym">)</span><span class="src-sym">{</span></li>
<li><a name="a23"></a>    echo <span class="src-str">'&lt;script&gt;alert(&quot;You need to enter a body of the article.&quot;);history.go(-1);&lt;/script&gt;'</span><span class="src-sym">;</span></li>
<li><a name="a24"></a>    <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'article_title'</span><span class="src-sym">] </span>= <span class="src-var">$article_title</span><span class="src-sym">;</span></li>
<li><a name="a25"></a>    <span class="src-key">exit</span><span class="src-sym">;</span></li>
<li><a name="a26"></a><span class="src-sym">}</span></li>
<li><a name="a27"></a>unset<span class="src-sym">(</span><span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'article_title'</span><span class="src-sym">]</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a28"></a><span class="src-comm">// print_r($_POST);</span></li>
<li><a name="a29"></a><span class="src-comm">// print_r($_SESSION);</span></li>
<li><a name="a30"></a><span class="src-key">if</span><span class="src-sym">( </span>isset<span class="src-sym">(</span><span class="src-var">$_POST</span><span class="src-sym">[</span><span class="src-str">'imageID'</span><span class="src-sym">]</span><span class="src-sym">) )</span><span class="src-sym">{</span><span class="src-comm">// is image checked??</span></li>
<li><a name="a31"></a>        <span class="src-var">$article_images </span>= <span class="src-var">$_POST</span><span class="src-sym">[</span><span class="src-str">'imageID'</span><span class="src-sym">]</span><span class="src-sym">;</span></li>
<li><a name="a32"></a><span class="src-sym">}</span></li>
<li><a name="a33"></a><span class="src-key">else</span><span class="src-sym">{</span></li>
<li><a name="a34"></a>    <span class="src-var">$article_images </span>= <span class="src-num">0</span><span class="src-sym">;</span></li>
<li><a name="a35"></a><span class="src-sym">}</span></li>
<li><a name="a36"></a>&nbsp;</li>
<li><a name="a37"></a><span class="src-var">$db </span>= <span class="src-key">new </span><span class="src-id"><a href="../brwcms/database.html">database</a></span><span class="src-sym">;</span></li>
<li><a name="a38"></a>&nbsp;</li>
<li><a name="a39"></a>&nbsp;</li>
<li><a name="a40"></a>&nbsp;</li>
<li><a name="a41"></a>&nbsp;</li>
<li><a name="a42"></a><span class="src-key">if </span><span class="src-sym">(</span>isset<span class="src-sym">( </span><span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'articleID'</span><span class="src-sym">] </span><span class="src-sym">)) </span><span class="src-sym">{</span></li>
<li><a name="a43"></a>    <span class="src-var">$articleID </span>= <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'articleID'</span><span class="src-sym">]</span><span class="src-sym">;</span></li>
<li><a name="a44"></a><span class="src-sym">}</span></li>
<li><a name="a45"></a><span class="src-comm">// if there is uploaded image, save it with the article</span></li>
<li><a name="a46"></a><span class="src-key">switch </span><span class="src-sym">( </span><span class="src-var">$_POST</span><span class="src-sym">[</span><span class="src-str">'task'</span><span class="src-sym">]</span><span class="src-sym">) </span><span class="src-sym">{</span></li>
<li><a name="a47"></a>    <span class="src-key">case </span><span class="src-str">'saveasdraft'</span>:</li>
<li><a name="a48"></a>        <span class="src-var">$userID </span>= <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'userID'</span><span class="src-sym">]</span><span class="src-sym">;</span></li>
<li><a name="a49"></a>        <span class="src-var">$created </span>= <a href="http://www.php.net/time">time</a><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a50"></a>        <span class="src-var">$m </span>= <a href="http://www.php.net/date">date</a><span class="src-sym">( </span><span class="src-str">'n'</span><span class="src-sym">, </span><span class="src-var">$created</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a51"></a>        <span class="src-var">$d </span>= <a href="http://www.php.net/date">date</a><span class="src-sym">( </span><span class="src-str">'j'</span><span class="src-sym">, </span><span class="src-var">$created</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a52"></a>        <span class="src-var">$y </span>= <a href="http://www.php.net/date">date</a><span class="src-sym">( </span><span class="src-str">'Y'</span><span class="src-sym">, </span><span class="src-var">$created</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a53"></a>        <span class="src-var">$sql </span>= <span class="src-str">&quot; insert into articles ( stageID, created, created_day, created_month, created_year, title, article_body) &quot;</span><span class="src-sym">;</span></li>
<li><a name="a54"></a>        <span class="src-var">$sql </span>.= <span class="src-str">&quot; </span><span class="src-id">values</span>( 1, <span class="src-var">$created</span>, <span class="src-var">$d</span>, <span class="src-var">$m</span>, <span class="src-var">$y</span>, '<span class="src-var">$article_title</span>', '<span class="src-var">$article_body</span>' )<span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a55"></a>        <span class="src-comm">//print 'add='.$sql ;                      </span></li>
<li><a name="a56"></a>                <span class="src-var">$result </span>= <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a57"></a>        <span class="src-comm">// TODO : must use the accessor methods here later, not directly accessing the variable...</span></li>
<li><a name="a58"></a>                <span class="src-var">$insertID </span>= <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">insertID</span><span class="src-sym">; </span></li>
<li><a name="a59"></a>        <span class="src-key">if </span><span class="src-sym">( </span><span class="src-var">$insertID </span><span class="src-sym">) </span><span class="src-sym">{ </span><span class="src-comm">// now lets insert the article with corresponding author</span></li>
<li><a name="a60"></a>                        <span class="src-var">$sql </span>= <span class="src-str">&quot; insert into article_author ( articleID , userID ) &quot;</span><span class="src-sym">;</span></li>
<li><a name="a61"></a>            <span class="src-var">$sql </span>.= <span class="src-str">&quot; </span><span class="src-id">values</span>( '<span class="src-var">$insertID</span>' , '<span class="src-var">$userID</span>') <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a62"></a>            <span class="src-var">$result </span>= <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a63"></a>            <span class="src-comm">// after saving the article with the author..then</span></li>
<li><a name="a64"></a>            <span class="src-comm">// lets save this article to the his corresponding category :)</span></li>
<li><a name="a65"></a>                        <span class="src-var">$sql </span>= <span class="src-str">&quot; insert into article_category ( articleID , categoryID ) &quot;</span><span class="src-sym">;</span></li>
<li><a name="a66"></a>            <span class="src-var">$sql </span>.= <span class="src-str">&quot; </span><span class="src-id">values</span>( '<span class="src-var">$insertID</span>' , '<span class="src-var">$categoryID</span>' ) <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a67"></a>            <span class="src-var">$result </span>= <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a68"></a>            </li>
<li><a name="a69"></a>            <span class="src-comm">// link the article to  the tasks.</span></li>
<li><a name="a70"></a>                        <span class="src-var">$sql </span>= <span class="src-str">&quot; insert into article_tasks ( articleID, taskID )&quot;</span><span class="src-sym">;</span></li>
<li><a name="a71"></a>            <span class="src-var">$sql </span>.= <span class="src-str">&quot; </span><span class="src-id">values</span>( '<span class="src-var">$insertID</span>', '<span class="src-var">$articletask</span>' )<span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a72"></a>            <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a73"></a>            </li>
<li><a name="a74"></a>            <span class="src-comm">// update the task status              </span></li>
<li><a name="a75"></a>                        <span class="src-var">$sql </span>= <span class="src-str">&quot;</span><a href="../brwcms/_code_db_fns_php.html#functionupdate">update</a> <span class="src-id">tasks set status</span> = '<span class="src-id">In Progress</span>' <span class="src-id">where taskID</span> = '<span class="src-var">$articletask</span>' <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a76"></a>            <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a77"></a>            </li>
<li><a name="a78"></a>            <span class="src-comm">// if naay image then ...attach it to the article</span></li>
<li><a name="a79"></a>                        <span class="src-key">if </span><span class="src-sym">(</span>isset<span class="src-sym">( </span><span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'article_imgs'</span><span class="src-sym">] </span><span class="src-sym">)) </span><span class="src-sym">{</span></li>
<li><a name="a80"></a>                <span class="src-var">$photo </span>= <span class="src-key">new </span><span class="src-id"><a href="../brwcms/stockphoto.html">stockphoto</a></span><span class="src-sym">;</span></li>
<li><a name="a81"></a>                <span class="src-var">$photo</span><span class="src-sym">-&gt;</span><span class="src-id">addImageToArticle</span><span class="src-sym">( </span><span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'article_imgs'</span><span class="src-sym">]</span><span class="src-sym">, </span><span class="src-var">$insertID </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a82"></a>            <span class="src-sym">}</span></li>
<li><a name="a83"></a>            </li>
<li><a name="a84"></a>            <span class="src-key">if </span><span class="src-sym">( </span><span class="src-var">$result </span><span class="src-sym">) </span><span class="src-sym">{</span></li>
<li><a name="a85"></a>                <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'task'</span><span class="src-sym">] </span>= <span class="src-str">'add'</span><span class="src-sym">;    </span></li>
<li><a name="a86"></a>                <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'articleID'</span><span class="src-sym">] </span>= <span class="src-var">$insertID</span><span class="src-sym">;</span></li>
<li><a name="a87"></a>                <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'title'</span><span class="src-sym">] </span>= <span class="src-var">$article_title</span><span class="src-sym">;</span></li>
<li><a name="a88"></a>                <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'article_body'</span><span class="src-sym">] </span>= <span class="src-var">$article_body</span><span class="src-sym">;</span></li>
<li><a name="a89"></a>                <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'dateline'</span><span class="src-sym">] </span>= <span class="src-var">$dateline</span><span class="src-sym">;</span></li>
<li><a name="a90"></a>                <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'created'</span><span class="src-sym">] </span>= <span class="src-var">$created</span><span class="src-sym">;</span></li>
<li><a name="a91"></a>                <span class="src-comm">// Log the activity</span></li>
<li><a name="a92"></a>                                <span class="src-var">$action </span>= <span class="src-key">new </span><span class="src-id"><a href="../brwcms/activity.html">activity</a></span><span class="src-sym">;</span></li>
<li><a name="a93"></a>                <span class="src-var">$action</span><span class="src-sym">-&gt;</span><span class="src-id">track_activity</span><span class="src-sym">( </span><span class="src-var">$userID</span><span class="src-sym">, </span><span class="src-var">$action</span><span class="src-sym">-&gt;</span><span class="src-id">saving_article</span><span class="src-sym">, </span><span class="src-str">'Saving the article '</span>.<span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'title'</span><span class="src-sym">] </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a94"></a>                <span class="src-var">$gotoURL </span>= <span class="src-str">&quot;../admin/my_articles2.php&quot;</span><span class="src-sym">;            </span></li>
<li><a name="a95"></a>            <span class="src-sym">}</span></li>
<li><a name="a96"></a>        <span class="src-sym">}</span></li>
<li><a name="a97"></a>        <span class="src-key">break</span><span class="src-sym">;</span></li>
<li><a name="a98"></a>    <span class="src-key">case </span><span class="src-str">'submit2editor'</span>:</li>
<li><a name="a99"></a>        <span class="src-key">if  </span><span class="src-sym">( </span>isset<span class="src-sym">( </span><span class="src-var">$articletask </span><span class="src-sym">) ) </span><span class="src-sym">{</span></li>
<li><a name="a100"></a>            <span class="src-var">$currenttime </span>= <a href="http://www.php.net/time">time</a><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a101"></a>            <span class="src-var">$sql </span>= <span class="src-str">&quot;</span><span class="src-id">select</span> * <span class="src-id">from tasks where taskID</span> = '<span class="src-var">$articletask</span>' <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a102"></a>            <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">(</span><span class="src-var">$sql</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a103"></a>            <span class="src-var">$gettask </span>= <span class="src-key">array</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a104"></a>            <span class="src-key">while </span><span class="src-sym">(</span><span class="src-var">$gettask</span><span class="src-sym">[</span><span class="src-sym">] </span>=  <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">fetcharray</span><span class="src-sym">(</span><span class="src-sym">))</span><span class="src-sym">;</span></li>
<li><a name="a105"></a>            <span class="src-var">$duedate </span>= <span class="src-var">$gettask</span><span class="src-sym">[</span><span class="src-num">0</span><span class="src-sym">]</span><span class="src-sym">-&gt;</span><span class="src-id">enddate</span><span class="src-sym">;</span></li>
<li><a name="a106"></a>            <span class="src-key">if </span><span class="src-sym">( </span><span class="src-var">$currenttime </span>&gt; <span class="src-var">$duedate </span><span class="src-sym">) </span><span class="src-sym">{</span></li>
<li><a name="a107"></a>                echo <span class="src-str">'&lt;script&gt;alert(&quot;Sorry, the article is no longer accepted because you haven\'t met the deadline of this task which is ' </span>. <span class="src-id">friendlydate5</span><span class="src-sym">(</span><span class="src-var">$duedate</span><span class="src-sym">) </span>. <span class="src-str">'.     If you really want to submit the article kindly contact the editor.&quot;);&lt;/script&gt;'</span><span class="src-sym">;</span></li>
<li><a name="a108"></a>                echo <span class="src-str">'&lt;script&gt;history.go(-1);&lt;/script&gt;'</span><span class="src-sym">;</span></li>
<li><a name="a109"></a>                <span class="src-key">exit</span><span class="src-sym">;</span></li>
<li><a name="a110"></a>            <span class="src-sym">}</span></li>
<li><a name="a111"></a>            <span class="src-key">else</span><span class="src-sym">{</span></li>
<li><a name="a112"></a>                <span class="src-var">$sql </span>= <span class="src-str">&quot;</span><a href="../brwcms/_code_db_fns_php.html#functionupdate">update</a> <span class="src-id">tasks set status</span> = '<span class="src-id">Completed</span>' <span class="src-id">where taskID</span> = '<span class="src-var">$articletask</span>' <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a113"></a>                <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">(</span><span class="src-var">$sql</span><span class="src-sym">)</span><span class="src-sym">;                </span></li>
<li><a name="a114"></a>            <span class="src-sym">}</span></li>
<li><a name="a115"></a>        <span class="src-sym">}</span></li>
<li><a name="a116"></a>        </li>
<li><a name="a117"></a>        <span class="src-key">if </span><span class="src-sym">( </span>isset<span class="src-sym">(</span><span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'articleID'</span><span class="src-sym">]</span><span class="src-sym">) ) </span><span class="src-sym">{</span></li>
<li><a name="a118"></a>            <span class="src-var">$created </span>= <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'created'</span><span class="src-sym">]</span><span class="src-sym">;</span></li>
<li><a name="a119"></a>            <span class="src-var">$d </span>= <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'created_day'</span><span class="src-sym">]</span><span class="src-sym">;</span></li>
<li><a name="a120"></a>            <span class="src-var">$m </span>=  <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'created_month'</span><span class="src-sym">]</span><span class="src-sym">;</span></li>
<li><a name="a121"></a>            <span class="src-var">$y </span>= <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'created_year'</span><span class="src-sym">]</span><span class="src-sym">;</span></li>
<li><a name="a122"></a>            <span class="src-var">$dateline </span>= <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'dateline'</span><span class="src-sym">]</span><span class="src-sym">;    </span></li>
<li><a name="a123"></a>            <span class="src-var">$articleID </span>= <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'articleID'</span><span class="src-sym">]</span><span class="src-sym">;</span></li>
<li><a name="a124"></a>            <span class="src-var">$sql </span>= <span class="src-str">&quot; select * from articles a&quot;</span><span class="src-sym">;</span></li>
<li><a name="a125"></a>            <span class="src-var">$sql </span>.= <span class="src-str">&quot; where a.articleID=&quot; </span>. <a href="http://www.php.net/intval">intval</a><span class="src-sym">(</span><span class="src-var">$articleID</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a126"></a>            <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a127"></a>            <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">fetcharray</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a128"></a>            <span class="src-comm">// Lets check first, if the article is already exists, if exist..lets update ok.</span></li>
<li><a name="a129"></a>                        <span class="src-key">if </span><span class="src-sym">(</span><span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">getnumrows</span><span class="src-sym">(</span><span class="src-sym">) </span>&gt; <span class="src-num">0 </span><span class="src-sym">)</span><span class="src-sym">{</span></li>
<li><a name="a130"></a>                <span class="src-var">$sql </span>= <span class="src-str">&quot; update articles &quot;</span><span class="src-sym">;</span></li>
<li><a name="a131"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot; set articles.stageID = 2 , articles.status = '--' , &quot;</span><span class="src-sym">;</span></li>
<li><a name="a132"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot; </span><span class="src-id">articles</span>.<span class="src-id">title</span> = '<span class="src-var">$article_title</span>' , <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a133"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot; </span><span class="src-id">articles</span>.<span class="src-id">article_body</span> = '<span class="src-var">$article_body</span>' <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a134"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot; where articles.articleID=&quot; </span>. <a href="http://www.php.net/intval">intval</a><span class="src-sym">(</span><span class="src-var">$articleID</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a135"></a>                <span class="src-var">$result </span>= <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a136"></a>            <span class="src-sym">}</span></li>
<li><a name="a137"></a>            <span class="src-key">else </span><span class="src-sym">{ </span><span class="src-comm">// otherwise, lets save the article to the database..no problem..</span></li>
<li><a name="a138"></a>                                <span class="src-var">$sql </span>= <span class="src-str">&quot; insert into articles ( stageID, status, created, created_day, created_month, created_year, title, article_body) &quot;</span><span class="src-sym">;</span></li>
<li><a name="a139"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot; </span><span class="src-id">values</span>( 2, '--', <span class="src-var">$created</span>, <span class="src-var">$created_day</span>, <span class="src-var">$created_month</span>, <span class="src-var">$created_year</span>, '<span class="src-var">$article_title</span>', '<span class="src-var">$article_body</span>' )<span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a140"></a>                <span class="src-var">$result </span>= <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a141"></a>            <span class="src-sym">}</span></li>
<li><a name="a142"></a>            <span class="src-comm">// Again, let's also check in the article versions if it exists..</span></li>
<li><a name="a143"></a>                        <span class="src-var">$sql </span>= <span class="src-str">&quot; select * from article_versions av &quot;</span><span class="src-sym">;</span></li>
<li><a name="a144"></a>            <span class="src-var">$sql </span>.= <span class="src-str">&quot; where av.articleID=&quot; </span>. <a href="http://www.php.net/intval">intval</a><span class="src-sym">(</span><span class="src-var">$articleID</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a145"></a>            <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a146"></a>            <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">fetcharray</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a147"></a>            <span class="src-key">if </span><span class="src-sym">( </span><span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">getNumrows</span><span class="src-sym">(</span><span class="src-sym">) </span>&gt; <span class="src-num">0 </span><span class="src-sym">) </span><span class="src-sym">{ </span><span class="src-comm">// yes weve found it,,then lets just update it ok</span></li>
<li><a name="a148"></a>                                <span class="src-var">$sql </span>= <span class="src-str">&quot; update article_versions &quot;</span><span class="src-sym">;</span></li>
<li><a name="a149"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot; set article_versions.stageID= '2' , &quot;</span><span class="src-sym">;</span></li>
<li><a name="a150"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot; </span><span class="src-id">article_versions</span>.<span class="src-id">title</span>= '<span class="src-var">$article_title</span>' , <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a151"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot; article_versions.edited_by = &quot; </span>. <a href="http://www.php.net/intval">intval</a><span class="src-sym">( </span><span class="src-var">$userID </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a152"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot;</span> , <span class="src-id">article_versions</span>.<span class="src-id">article_body</span> = '<span class="src-var">$article_body</span>' , <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a153"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot; </span><span class="src-id">article_versions</span>.<span class="src-id">created</span>= '<span class="src-var">$created</span>' , <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a154"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot; article_versions.status = '--' &quot;</span><span class="src-sym">;</span></li>
<li><a name="a155"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot; where article_versions.articleID=&quot; </span>. <a href="http://www.php.net/intval">intval</a><span class="src-sym">(</span><span class="src-var">$articleID</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a156"></a>                <span class="src-key">if </span><span class="src-sym">(</span><span class="src-sym">!</span><span class="src-sym">(</span><span class="src-var">$result </span>= <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">))) </span><span class="src-sym">{</span></li>
<li><a name="a157"></a>                    <span class="src-key">die </span><span class="src-sym">( </span><span class="src-str">'Error:' </span>. <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">error</span><span class="src-sym">(</span><span class="src-sym">) )</span><span class="src-sym">;</span></li>
<li><a name="a158"></a>                <span class="src-sym">}</span></li>
<li><a name="a159"></a>            <span class="src-sym">}</span></li>
<li><a name="a160"></a>            <span class="src-key">else</span><span class="src-sym">{ </span><span class="src-comm">// else, we hav to make a separate copy frm the original article..</span></li>
<li><a name="a161"></a>                                <span class="src-var">$sql </span>= <span class="src-str">&quot; insert into article_versions ( articleID, stageID, status, created, created_day, created_month, created_year, title, article_body )&quot;</span><span class="src-sym">;</span></li>
<li><a name="a162"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot; </span><span class="src-id">values</span> ( <span class="src-var">$articleID</span>, 2, '--',  <span class="src-var">$created</span>, <span class="src-var">$d</span>, <span class="src-var">$m</span>, <span class="src-var">$y</span>, '<span class="src-var">$article_title</span>', '<span class="src-var">$article_body</span>' ) <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a163"></a>                <span class="src-key">if </span><span class="src-sym">(</span><span class="src-sym">!</span><span class="src-sym">(</span><span class="src-var">$result </span>= <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">))) </span><span class="src-sym">{</span></li>
<li><a name="a164"></a>                    <span class="src-key">die </span><span class="src-sym">( </span><span class="src-str">'Error:' </span>. <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">error</span><span class="src-sym">(</span><span class="src-sym">) )</span><span class="src-sym">;</span></li>
<li><a name="a165"></a>                <span class="src-sym">}</span></li>
<li><a name="a166"></a>            <span class="src-sym">}</span></li>
<li><a name="a167"></a>        </li>
<li><a name="a168"></a>        <span class="src-sym">}</span></li>
<li><a name="a169"></a>        <span class="src-key">else</span><span class="src-sym">{ </span><span class="src-comm">// submit automatic to editor...</span></li>
<li><a name="a170"></a>                        <span class="src-var">$created </span>= <a href="http://www.php.net/time">time</a><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a171"></a>            <span class="src-var">$m </span>= <a href="http://www.php.net/date">date</a><span class="src-sym">( </span><span class="src-str">'n'</span><span class="src-sym">, </span><span class="src-var">$created</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a172"></a>            <span class="src-var">$d </span>= <a href="http://www.php.net/date">date</a><span class="src-sym">( </span><span class="src-str">'j'</span><span class="src-sym">, </span><span class="src-var">$created</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a173"></a>            <span class="src-var">$y </span>= <a href="http://www.php.net/date">date</a><span class="src-sym">( </span><span class="src-str">'Y'</span><span class="src-sym">, </span><span class="src-var">$created</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a174"></a>            <span class="src-var">$categoryID     </span>= <span class="src-var">$_POST</span><span class="src-sym">[</span><span class="src-str">'category'</span><span class="src-sym">]</span><span class="src-sym">;</span></li>
<li><a name="a175"></a>            <span class="src-var">$article_title     </span>= <span class="src-var">$_POST</span><span class="src-sym">[</span><span class="src-str">'title'</span><span class="src-sym">]</span><span class="src-sym">;</span></li>
<li><a name="a176"></a>            <span class="src-var">$article_body     </span>= <span class="src-var">$_POST</span><span class="src-sym">[</span><span class="src-str">'elm1'</span><span class="src-sym">]</span><span class="src-sym">;</span></li>
<li><a name="a177"></a>            </li>
<li><a name="a178"></a>            <span class="src-var">$sql </span>= <span class="src-str">&quot; insert into articles ( stageID, status, created, created_day, created_month, created_year, title, article_body) &quot;</span><span class="src-sym">;</span></li>
<li><a name="a179"></a>            <span class="src-var">$sql </span>.= <span class="src-str">&quot; </span><span class="src-id">values</span>( 2, '--', <span class="src-var">$created</span>, <span class="src-var">$d</span>, <span class="src-var">$m</span>, <span class="src-var">$y</span>, '<span class="src-var">$article_title</span>', '<span class="src-var">$article_body</span>' )<span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a180"></a>            <span class="src-var">$result </span>= <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a181"></a>            <span class="src-var">$insertID </span>= <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">insertID</span><span class="src-sym">; </span></li>
<li><a name="a182"></a>            <span class="src-key">if </span><span class="src-sym">( </span><span class="src-var">$insertID </span><span class="src-sym">) </span><span class="src-sym">{ </span><span class="src-comm">// now lets insert the article with corresponding author</span></li>
<li><a name="a183"></a>                                <span class="src-var">$sql </span>= <span class="src-str">&quot; insert into article_author ( articleID , userID ) &quot;</span><span class="src-sym">;</span></li>
<li><a name="a184"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot; </span><span class="src-id">values</span>( '<span class="src-var">$insertID</span>' , '<span class="src-var">$userID</span>') <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a185"></a>                <span class="src-var">$result </span>= <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a186"></a>                <span class="src-comm">// after saving the article with the author..then</span></li>
<li><a name="a187"></a>                <span class="src-comm">// lets save this article to the his corresponding category :)</span></li>
<li><a name="a188"></a>                                <span class="src-var">$sql </span>= <span class="src-str">&quot; insert into article_category ( articleID , categoryID ) &quot;</span><span class="src-sym">;</span></li>
<li><a name="a189"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot; </span><span class="src-id">values</span>( '<span class="src-var">$insertID</span>' , '<span class="src-var">$categoryID</span>' ) <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a190"></a>                <span class="src-var">$result </span>= <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a191"></a>                <span class="src-comm">// add to article version.</span></li>
<li><a name="a192"></a>                                <span class="src-var">$sql </span>= <span class="src-str">&quot; insert into article_versions ( articleID, stageID, status, created, created_day, created_month, created_year, title, article_body )&quot;</span><span class="src-sym">;</span></li>
<li><a name="a193"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot; </span><span class="src-id">values</span> ( <span class="src-var">$insertID</span>, 2, '--',  <span class="src-var">$created</span>, <span class="src-var">$d</span>, <span class="src-var">$m</span>, <span class="src-var">$y</span>, '<span class="src-var">$article_title</span>', '<span class="src-var">$article_body</span>' ) <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a194"></a>                <span class="src-key">if </span><span class="src-sym">(</span><span class="src-sym">!</span><span class="src-sym">(</span><span class="src-var">$result </span>= <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">))) </span><span class="src-sym">{</span></li>
<li><a name="a195"></a>                    <span class="src-key">die </span><span class="src-sym">( </span><span class="src-str">'Error:' </span>. <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">error</span><span class="src-sym">(</span><span class="src-sym">) )</span><span class="src-sym">;</span></li>
<li><a name="a196"></a>                <span class="src-sym">}</span></li>
<li><a name="a197"></a>                <span class="src-key">if </span><span class="src-sym">( </span><span class="src-var">$result </span><span class="src-sym">) </span><span class="src-sym">{</span></li>
<li><a name="a198"></a>                    <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'task'</span><span class="src-sym">] </span>= <span class="src-str">'add'</span><span class="src-sym">;    </span></li>
<li><a name="a199"></a>                    <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'articleID'</span><span class="src-sym">] </span>= <span class="src-var">$insertID</span><span class="src-sym">;</span></li>
<li><a name="a200"></a>                    <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'title'</span><span class="src-sym">] </span>= <span class="src-var">$article_title</span><span class="src-sym">;</span></li>
<li><a name="a201"></a>                    <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'article_body'</span><span class="src-sym">] </span>= <span class="src-var">$article_body</span><span class="src-sym">;</span></li>
<li><a name="a202"></a>                    <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'dateline'</span><span class="src-sym">] </span>= <span class="src-var">$dateline</span><span class="src-sym">;</span></li>
<li><a name="a203"></a>                    <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'created'</span><span class="src-sym">] </span>= <span class="src-var">$created</span><span class="src-sym">;</span></li>
<li><a name="a204"></a>                    <span class="src-comm">// Log the activity</span></li>
<li><a name="a205"></a>                                        <span class="src-var">$action </span>= <span class="src-key">new </span><span class="src-id"><a href="../brwcms/activity.html">activity</a></span><span class="src-sym">;</span></li>
<li><a name="a206"></a>                    <span class="src-var">$action</span><span class="src-sym">-&gt;</span><span class="src-id">track_activity</span><span class="src-sym">( </span><span class="src-var">$userID</span><span class="src-sym">, </span><span class="src-var">$action</span><span class="src-sym">-&gt;</span><span class="src-id">saving_article</span><span class="src-sym">, </span><span class="src-str">'Saving the article '</span>.<span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'title'</span><span class="src-sym">] </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a207"></a>                    <span class="src-var">$gotoURL </span>= <span class="src-str">&quot;../admin/my_articles2.php&quot;</span><span class="src-sym">;            </span></li>
<li><a name="a208"></a>                <span class="src-sym">}</span></li>
<li><a name="a209"></a>            <span class="src-sym">}</span></li>
<li><a name="a210"></a>        <span class="src-sym">}</span></li>
<li><a name="a211"></a>        <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'task'</span><span class="src-sym">] </span>= <span class="src-str">'submit'</span><span class="src-sym">;</span></li>
<li><a name="a212"></a>        <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'title'</span><span class="src-sym">] </span>= <span class="src-var">$article_title</span><span class="src-sym">;</span></li>
<li><a name="a213"></a>        <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'to'</span><span class="src-sym">] </span>= <span class="src-str">'News Editor'</span><span class="src-sym">;</span></li>
<li><a name="a214"></a>        <span class="src-var">$gotoURL </span>= <span class="src-str">&quot;../admin/my_articles2.php&quot;</span><span class="src-sym">;    </span></li>
<li><a name="a215"></a>        <span class="src-key">break</span><span class="src-sym">;</span></li>
<li><a name="a216"></a>    <span class="src-key">case </span><span class="src-str">'edit'</span>:</li>
<li><a name="a217"></a>        <span class="src-comm">// update the task status              </span></li>
<li><a name="a218"></a>                <span class="src-var">$sql </span>= <span class="src-str">&quot;</span><a href="../brwcms/_code_db_fns_php.html#functionupdate">update</a> <span class="src-id">tasks set status</span> = '<span class="src-id">In Progress</span>' <span class="src-id">where taskID</span> = '<span class="src-var">$articletask</span>' <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a219"></a>        <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a220"></a>&nbsp;</li>
<li><a name="a221"></a>        <span class="src-key">if </span><span class="src-sym">(</span>isset<span class="src-sym">( </span><span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'article_imgs'</span><span class="src-sym">] </span><span class="src-sym">)) </span><span class="src-sym">{</span></li>
<li><a name="a222"></a>            <span class="src-var">$photo </span>= <span class="src-key">new </span><span class="src-id"><a href="../brwcms/stockphoto.html">stockphoto</a></span><span class="src-sym">;</span></li>
<li><a name="a223"></a>            <span class="src-var">$photo</span><span class="src-sym">-&gt;</span><span class="src-id">addImageToArticle</span><span class="src-sym">( </span><span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'article_imgs'</span><span class="src-sym">]</span><span class="src-sym">, </span><span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'articleID'</span><span class="src-sym">] </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a224"></a>        <span class="src-sym">}</span></li>
<li><a name="a225"></a>&nbsp;</li>
<li><a name="a226"></a>        <span class="src-key">switch</span><span class="src-sym">( </span><span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'stageID'</span><span class="src-sym">] </span><span class="src-sym">)</span><span class="src-sym">{</span></li>
<li><a name="a227"></a>            <span class="src-key">case </span><span class="src-num">1</span>:</li>
<li><a name="a228"></a>                <span class="src-comm">// this article belongs to news draft stage, but it is edited by the writer..</span></li>
<li><a name="a229"></a>                <span class="src-comm">// maybe he has left to put something on the article, right..</span></li>
<li><a name="a230"></a>                                <span class="src-var">$modified </span>= <a href="http://www.php.net/time">time</a><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a231"></a>                <span class="src-var">$sql </span>= <span class="src-str">&quot; update articles &quot;</span><span class="src-sym">;</span></li>
<li><a name="a232"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot; set articles.stageID=&quot; </span>. <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'stageID'</span><span class="src-sym">]</span><span class="src-sym">;</span></li>
<li><a name="a233"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot;</span> , <span class="src-id">articles</span>.<span class="src-id">title</span> = '<span class="src-var">$article_title</span>' <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a234"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot;</span> , <span class="src-id">articles</span>.<span class="src-id">modified</span> = '<span class="src-var">$modified</span>' , <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a235"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot; articles.status = '--' &quot;</span><span class="src-sym">;</span></li>
<li><a name="a236"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot;</span> , <span class="src-id">articles</span>.<span class="src-id">article_body</span> = '<span class="src-var">$article_body</span>' <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a237"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot; where articles.articleID=&quot; </span>. <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'articleID'</span><span class="src-sym">]</span><span class="src-sym">;</span></li>
<li><a name="a238"></a>                <span class="src-var">$result </span>= <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a239"></a>                <span class="src-key">if </span><span class="src-sym">( </span><span class="src-var">$result </span><span class="src-sym">) </span><span class="src-sym">{</span></li>
<li><a name="a240"></a>                    <span class="src-comm">// Log the activity</span></li>
<li><a name="a241"></a>                                        <span class="src-var">$action </span>= <span class="src-key">new </span><span class="src-id"><a href="../brwcms/activity.html">activity</a></span><span class="src-sym">;</span></li>
<li><a name="a242"></a>                    <span class="src-var">$action</span><span class="src-sym">-&gt;</span><span class="src-id">track_activity</span><span class="src-sym">( </span><span class="src-var">$userID</span><span class="src-sym">, </span><span class="src-var">$action</span><span class="src-sym">-&gt;</span><span class="src-id">saving_article</span><span class="src-sym">, </span><span class="src-str">'Saving the article ' </span>. <span class="src-var">$article_title </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a243"></a>                    <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'task'</span><span class="src-sym">] </span>= <span class="src-str">'edit'</span><span class="src-sym">;    </span></li>
<li><a name="a244"></a>                    <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'title'</span><span class="src-sym">] </span>= <span class="src-var">$article_title</span><span class="src-sym">;</span></li>
<li><a name="a245"></a>                <span class="src-sym">}</span></li>
<li><a name="a246"></a>                <span class="src-comm">// if the writer decided to change the category of the article..</span></li>
<li><a name="a247"></a>                <span class="src-comm">// then lets update it ok..</span></li>
<li><a name="a248"></a>                                <span class="src-key">if </span><span class="src-sym">( </span><span class="src-var">$categoryID </span><span class="src-sym">) </span><span class="src-sym">{</span></li>
<li><a name="a249"></a>                    <span class="src-var">$sql </span>= <span class="src-str">&quot; select * from article_category ac &quot;</span><span class="src-sym">;</span></li>
<li><a name="a250"></a>                    <span class="src-var">$sql </span>.= <span class="src-str">&quot; where ac.articleID=&quot; </span>. <a href="http://www.php.net/intval">intval</a><span class="src-sym">( </span><span class="src-var">$articleID </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a251"></a>                    <span class="src-key">if </span><span class="src-sym">(</span><span class="src-sym">!</span><span class="src-sym">(</span><span class="src-var">$result </span>= <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">))) </span><span class="src-sym">{</span></li>
<li><a name="a252"></a>                        <span class="src-key">die </span><span class="src-sym">( </span><span class="src-str">'Error:' </span>. <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">error</span><span class="src-sym">(</span><span class="src-sym">) )</span><span class="src-sym">;</span></li>
<li><a name="a253"></a>                    <span class="src-sym">}</span></li>
<li><a name="a254"></a>                    <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">fetcharray</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a255"></a>                    <span class="src-key">if </span><span class="src-sym">( </span><span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">getNumrows</span><span class="src-sym">(</span><span class="src-sym">) </span>&gt; <span class="src-num">0 </span><span class="src-sym">) </span><span class="src-sym">{</span></li>
<li><a name="a256"></a>                        <span class="src-var">$sql </span>= <span class="src-str">&quot; update article_category &quot;</span><span class="src-sym">;</span></li>
<li><a name="a257"></a>                        <span class="src-var">$sql </span>.= <span class="src-str">&quot; </span><span class="src-id">set categoryID</span>= '<span class="src-var">$categoryID</span>' <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a258"></a>                        <span class="src-var">$sql </span>.= <span class="src-str">&quot; where articleID=&quot; </span>. <a href="http://www.php.net/intval">intval</a><span class="src-sym">( </span><span class="src-var">$articleID </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a259"></a>                        <span class="src-var">$result </span>= <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a260"></a>                    <span class="src-sym">}</span></li>
<li><a name="a261"></a>                    <span class="src-key">else</span><span class="src-sym">{</span></li>
<li><a name="a262"></a>                        <span class="src-var">$sql </span>= <span class="src-str">&quot; insert into article_category ( articleID , categoryID ) &quot;</span><span class="src-sym">;</span></li>
<li><a name="a263"></a>                        <span class="src-var">$sql </span>.= <span class="src-str">&quot; </span><span class="src-id">values</span>( '<span class="src-var">$insertID</span>' , '<span class="src-var">$categoryID</span>' ) <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a264"></a>                        <span class="src-var">$result </span>= <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a265"></a>                    <span class="src-sym">}</span></li>
<li><a name="a266"></a>                <span class="src-sym">}                    </span></li>
<li><a name="a267"></a>                <span class="src-var">$gotoURL </span>= <span class="src-str">&quot;../admin/my_articles2.php&quot;</span><span class="src-sym">;    </span></li>
<li><a name="a268"></a>                <span class="src-key">break</span><span class="src-sym">;</span></li>
<li><a name="a269"></a>            <span class="src-key">case </span><span class="src-num">2</span>:</li>
<li><a name="a270"></a>            <span class="src-key">case </span><span class="src-num">3</span>:</li>
<li><a name="a271"></a>                <span class="src-var">$stage </span>= <span class="src-num">2</span><span class="src-sym">;</span></li>
<li><a name="a272"></a>                <span class="src-var">$sql </span>= <span class="src-str">&quot;update articles &quot;</span><span class="src-sym">;</span></li>
<li><a name="a273"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot;</span><span class="src-id">set stageID</span>= <span class="src-var">$stage</span>, <span class="src-id">status</span> = '--' <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a274"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot; where articleID=&quot; </span>. <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'articleID'</span><span class="src-sym">]</span><span class="src-sym">;    </span></li>
<li><a name="a275"></a>                <span class="src-var">$result </span>= <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a276"></a>                </li>
<li><a name="a277"></a>                <span class="src-var">$modified </span>= <a href="http://www.php.net/time">time</a><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a278"></a>                <span class="src-var">$sql </span>= <span class="src-str">&quot; update article_versions &quot;</span><span class="src-sym">;</span></li>
<li><a name="a279"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot; set article_versions.stageID=&quot; </span>. <span class="src-var">$stage</span><span class="src-sym">;</span></li>
<li><a name="a280"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot;</span> , <span class="src-id">article_versions</span>.<span class="src-id">title</span> = '<span class="src-var">$article_title</span>' <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a281"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot;</span> , <span class="src-id">article_versions</span>.<span class="src-id">article_body</span> = '<span class="src-var">$article_body</span>' <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a282"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot;</span> , <span class="src-id">article_versions</span>.<span class="src-id">modified</span> = '<span class="src-var">$modified</span>' <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a283"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot; , article_versions.status = '--' &quot;</span><span class="src-sym">;</span></li>
<li><a name="a284"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot; , article_versions.edited_by=&quot; </span>. <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'userID'</span><span class="src-sym">]</span><span class="src-sym">;</span></li>
<li><a name="a285"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot; where article_versions.articleID=&quot; </span>. <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'articleID'</span><span class="src-sym">]</span><span class="src-sym">;</span></li>
<li><a name="a286"></a>                <span class="src-var">$result </span>= <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a287"></a>                <span class="src-key">if </span><span class="src-sym">( </span><span class="src-var">$result </span><span class="src-sym">) </span><span class="src-sym">{</span></li>
<li><a name="a288"></a>                    <span class="src-comm">// Log the activity</span></li>
<li><a name="a289"></a>                                        <span class="src-var">$action </span>= <span class="src-key">new </span><span class="src-id"><a href="../brwcms/activity.html">activity</a></span><span class="src-sym">;</span></li>
<li><a name="a290"></a>                    <span class="src-var">$action</span><span class="src-sym">-&gt;</span><span class="src-id">track_activity</span><span class="src-sym">( </span><span class="src-var">$userID</span><span class="src-sym">, </span><span class="src-var">$action</span><span class="src-sym">-&gt;</span><span class="src-id">saving_article</span><span class="src-sym">, </span><span class="src-str">'Saving the article ' </span>. <span class="src-var">$article_title </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a291"></a>                    <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'task'</span><span class="src-sym">] </span>= <span class="src-str">'edit'</span><span class="src-sym">;    </span></li>
<li><a name="a292"></a>                    <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'title'</span><span class="src-sym">] </span>= <span class="src-var">$article_title</span><span class="src-sym">;</span></li>
<li><a name="a293"></a>                    <span class="src-var">$gotoURL </span>= <span class="src-str">&quot;../admin/view_article_versions.php?stageID=&quot;</span>.<span class="src-var">$_SESSION</span><span class="src-sym">[ </span><span class="src-str">'stageID' </span><span class="src-sym">]</span><span class="src-sym">;</span></li>
<li><a name="a294"></a>                <span class="src-sym">}</span></li>
<li><a name="a295"></a>                <span class="src-key">break</span><span class="src-sym">;</span></li>
<li><a name="a296"></a>            <span class="src-key">case </span><span class="src-num">4</span>:</li>
<li><a name="a297"></a>            <span class="src-key">case </span><span class="src-num">5</span>:</li>
<li><a name="a298"></a>            <span class="src-key">case </span><span class="src-num">6</span>:</li>
<li><a name="a299"></a>            <span class="src-key">break</span><span class="src-sym">;            </span></li>
<li><a name="a300"></a>        <span class="src-sym">}</span><span class="src-comm">// END OF switch( $_SESSION['stageID'] ) </span></li>
<li><a name="a301"></a>        <span class="src-comm">// if the writer decided to change the category of the article..</span></li>
<li><a name="a302"></a>        <span class="src-comm">// then lets update it ok..</span></li>
<li><a name="a303"></a>                <span class="src-key">if </span><span class="src-sym">( </span><span class="src-var">$categoryID </span><span class="src-sym">) </span><span class="src-sym">{</span></li>
<li><a name="a304"></a>            <span class="src-var">$sql </span>= <span class="src-str">&quot; select * from article_category ac &quot;</span><span class="src-sym">;</span></li>
<li><a name="a305"></a>            <span class="src-var">$sql </span>.= <span class="src-str">&quot; where ac.articleID=&quot; </span>. <a href="http://www.php.net/intval">intval</a><span class="src-sym">( </span><span class="src-var">$articleID </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a306"></a>            <span class="src-key">if </span><span class="src-sym">(</span><span class="src-sym">!</span><span class="src-sym">(</span><span class="src-var">$result </span>= <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">))) </span><span class="src-sym">{</span></li>
<li><a name="a307"></a>                <span class="src-key">die </span><span class="src-sym">( </span><span class="src-str">'Error:' </span>. <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">error</span><span class="src-sym">(</span><span class="src-sym">) )</span><span class="src-sym">;</span></li>
<li><a name="a308"></a>            <span class="src-sym">}</span></li>
<li><a name="a309"></a>            <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">fetcharray</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a310"></a>            <span class="src-key">if </span><span class="src-sym">( </span><span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">getNumrows</span><span class="src-sym">(</span><span class="src-sym">) </span>&gt; <span class="src-num">0 </span><span class="src-sym">) </span><span class="src-sym">{</span></li>
<li><a name="a311"></a>                <span class="src-var">$sql </span>= <span class="src-str">&quot; update article_category &quot;</span><span class="src-sym">;</span></li>
<li><a name="a312"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot; </span><span class="src-id">set categoryID</span>= '<span class="src-var">$categoryID</span>' <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a313"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot; where articleID=&quot; </span>. <a href="http://www.php.net/intval">intval</a><span class="src-sym">( </span><span class="src-var">$articleID </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a314"></a>                <span class="src-var">$result </span>= <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a315"></a>            <span class="src-sym">}</span></li>
<li><a name="a316"></a>            <span class="src-key">else</span><span class="src-sym">{</span></li>
<li><a name="a317"></a>                <span class="src-var">$sql </span>= <span class="src-str">&quot; insert into article_category ( articleID , categoryID ) &quot;</span><span class="src-sym">;</span></li>
<li><a name="a318"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot; </span><span class="src-id">values</span>( '<span class="src-var">$insertID</span>' , '<span class="src-var">$categoryID</span>' ) <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a319"></a>                <span class="src-var">$result </span>= <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a320"></a>            <span class="src-sym">}</span></li>
<li><a name="a321"></a>        <span class="src-sym">}                    </span></li>
<li><a name="a322"></a>        <span class="src-key">break</span><span class="src-sym">;</span></li>
<li><a name="a323"></a>        <span class="src-key">case </span><span class="src-str">'submit2newsdirector'</span>:</li>
<li><a name="a324"></a>            <span class="src-comm">// Now the article has been passed to stage 3 in which the newsdirector will review it :)</span></li>
<li><a name="a325"></a>                        <span class="src-var">$sql </span>= <span class="src-str">&quot; update articles &quot;</span><span class="src-sym">;</span></li>
<li><a name="a326"></a>            <span class="src-var">$sql </span>.= <span class="src-str">&quot; set articles.stageID='3' , &quot;</span><span class="src-sym">;</span></li>
<li><a name="a327"></a>            <span class="src-var">$sql </span>.= <span class="src-str">&quot; articles.status='edited' &quot;</span><span class="src-sym">;</span></li>
<li><a name="a328"></a>            <span class="src-var">$sql </span>.= <span class="src-str">&quot; where articles.articleID=&quot; </span>. <a href="http://www.php.net/intval">intval</a><span class="src-sym">(</span><span class="src-var">$articleID</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a329"></a>            <span class="src-key">if </span><span class="src-sym">(</span><span class="src-sym">!</span><span class="src-sym">(</span><span class="src-var">$result </span>= <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">))) </span><span class="src-sym">{</span></li>
<li><a name="a330"></a>                <span class="src-key">die </span><span class="src-sym">( </span><span class="src-str">'Error:' </span>. <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">error</span><span class="src-sym">(</span><span class="src-sym">) )</span><span class="src-sym">;</span></li>
<li><a name="a331"></a>            <span class="src-sym">}</span></li>
<li><a name="a332"></a>            </li>
<li><a name="a333"></a>            <span class="src-var">$sql </span>= <span class="src-str">&quot; select * from article_versions av &quot;</span><span class="src-sym">;</span></li>
<li><a name="a334"></a>            <span class="src-var">$sql </span>.= <span class="src-str">&quot; where av.articleID=&quot; </span>. <a href="http://www.php.net/intval">intval</a><span class="src-sym">(</span><span class="src-var">$articleID</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a335"></a>            <span class="src-comm">// print $sql;</span></li>
<li><a name="a336"></a>                        <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a337"></a>            <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">fetcharray</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a338"></a>            <span class="src-key">if </span><span class="src-sym">( </span><span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">getNumrows</span><span class="src-sym">(</span><span class="src-sym">) </span>&gt; <span class="src-num">0 </span><span class="src-sym">) </span><span class="src-sym">{</span></li>
<li><a name="a339"></a>                <span class="src-var">$sql </span>= <span class="src-str">&quot; update article_versions &quot;</span><span class="src-sym">;</span></li>
<li><a name="a340"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot; set article_versions.stageID= '3' , &quot;</span><span class="src-sym">;</span></li>
<li><a name="a341"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot; </span><span class="src-id">article_versions</span>.<span class="src-id">edited_by</span>= <span class="src-var">$userID</span> , <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a342"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot; article_versions.status='edited' &quot;</span><span class="src-sym">;</span></li>
<li><a name="a343"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot;</span> , <span class="src-id">article_versions</span>.<span class="src-id">title</span> = '<span class="src-var">$article_title</span>' <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a344"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot;</span> , <span class="src-id">article_versions</span>.<span class="src-id">article_body</span> = '<span class="src-var">$article_body</span>' <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a345"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot;</span> , <span class="src-id">article_versions</span>.<span class="src-id">modified</span> = '<span class="src-var">$modified</span>' <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a346"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot; where article_versions.articleID=&quot; </span>. <a href="http://www.php.net/intval">intval</a><span class="src-sym">(</span><span class="src-var">$articleID</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a347"></a>                <span class="src-comm">//echo $sql;</span></li>
<li><a name="a348"></a>                                <span class="src-key">if </span><span class="src-sym">(</span><span class="src-sym">!</span><span class="src-sym">(</span><span class="src-var">$result </span>= <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">))) </span><span class="src-sym">{</span></li>
<li><a name="a349"></a>                    <span class="src-key">die </span><span class="src-sym">( </span><span class="src-str">'Error:' </span>. <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">error</span><span class="src-sym">(</span><span class="src-sym">) )</span><span class="src-sym">;</span></li>
<li><a name="a350"></a>                <span class="src-sym">}</span></li>
<li><a name="a351"></a>            <span class="src-sym">}</span></li>
<li><a name="a352"></a>            <span class="src-key">else</span><span class="src-sym">{</span></li>
<li><a name="a353"></a>                <span class="src-var">$sql </span>= <span class="src-str">&quot; insert into article_versions ( articleID, stageID, status, created, dateline, title, article_body, edited_by )&quot;</span><span class="src-sym">;</span></li>
<li><a name="a354"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot; </span><span class="src-id">values</span> ( '<span class="src-var">$articleID</span>', '3' , '<span class="src-id">edited</span>', <span class="src-var">$created</span>, <span class="src-var">$dateline</span>, '<span class="src-var">$title</span>', '<span class="src-var">$article_body</span>' , '<span class="src-var">$userID</span>') <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a355"></a>                <span class="src-key">if </span><span class="src-sym">(</span><span class="src-sym">!</span><span class="src-sym">(</span><span class="src-var">$result </span>= <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">))) </span><span class="src-sym">{</span></li>
<li><a name="a356"></a>                    <span class="src-key">die </span><span class="src-sym">( </span><span class="src-str">'Error:' </span>. <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">error</span><span class="src-sym">(</span><span class="src-sym">) )</span><span class="src-sym">;</span></li>
<li><a name="a357"></a>                <span class="src-sym">}</span></li>
<li><a name="a358"></a>            <span class="src-sym">}</span></li>
<li><a name="a359"></a>            <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'task'</span><span class="src-sym">] </span>= <span class="src-str">'sent'</span><span class="src-sym">;</span></li>
<li><a name="a360"></a>            <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'title'</span><span class="src-sym">] </span>= <span class="src-var">$article_title </span><span class="src-sym">;</span></li>
<li><a name="a361"></a>            <span class="src-var">$_SESSION</span><span class="src-sym">[</span><span class="src-str">'to'</span><span class="src-sym">] </span>= <span class="src-str">'News Director'</span><span class="src-sym">;</span></li>
<li><a name="a362"></a>            <span class="src-var">$gotoURL </span>=  <span class="src-str">&quot; view_article_versions.php?stageID=3&quot;</span><span class="src-sym">;</span></li>
<li><a name="a363"></a>        <span class="src-key">break</span><span class="src-sym">;</span></li>
<li><a name="a364"></a><span class="src-sym">}</span></li>
<li><a name="a365"></a>&nbsp;</li>
<li><a name="a366"></a><span class="src-comm">// continue here...my bitok is hungry,,eat sa ko...tara na eat tau may petsa-pie ako d2</span></li>
<li><a name="a367"></a><span class="src-comm">// if the news editor set the article to the frontpage..then lets put it to the frontpage ok.</span></li>
<li><a name="a368"></a><span class="src-comm">// Let check if this article has been set on the frontpage</span></li>
<li><a name="a369"></a><span class="src-comm">//print_r($_POST);</span></li>
<li><a name="a370"></a><span class="src-key">if </span><span class="src-sym">( </span><span class="src-var">$frontpage </span><span class="src-sym">) </span><span class="src-sym">{</span></li>
<li><a name="a371"></a>    <span class="src-var">$sql </span>= <span class="src-str">&quot; select * from article_frontpage af &quot;</span><span class="src-sym">;</span></li>
<li><a name="a372"></a>    <span class="src-var">$sql </span>.= <span class="src-str">&quot; where af.articleID =&quot; </span>. <a href="http://www.php.net/intval">intval</a><span class="src-sym">( </span><span class="src-var">$articleID </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a373"></a>    <span class="src-key">if </span><span class="src-sym">(</span><span class="src-sym">!</span><span class="src-sym">(</span><span class="src-var">$result </span>= <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">))) </span><span class="src-sym">{</span></li>
<li><a name="a374"></a>        <span class="src-key">die </span><span class="src-sym">( </span><span class="src-str">'Error:' </span>. <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">error</span><span class="src-sym">(</span><span class="src-sym">) )</span><span class="src-sym">;</span></li>
<li><a name="a375"></a>    <span class="src-sym">}</span></li>
<li><a name="a376"></a>    <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">fetcharray</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a377"></a>    <span class="src-key">if </span><span class="src-sym">( </span><span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">getNumrows</span><span class="src-sym">(</span><span class="src-sym">) </span>&gt; <span class="src-num">0 </span><span class="src-sym">) </span><span class="src-sym">{ </span><span class="src-comm">// if found, lets update it..</span></li>
<li><a name="a378"></a>                <span class="src-var">$sql </span>= <span class="src-str">&quot; update article_frontpage &quot;</span><span class="src-sym">;</span></li>
<li><a name="a379"></a>        <span class="src-var">$sql </span>.= <span class="src-str">&quot; set frontpage_sectionID = &quot; </span>. <a href="http://www.php.net/intval">intval</a><span class="src-sym">( </span><span class="src-var">$frontpage </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a380"></a>        <span class="src-var">$sql </span>.= <span class="src-str">&quot; where articleID=&quot; </span>. <a href="http://www.php.net/intval">intval</a><span class="src-sym">( </span><span class="src-var">$articleID </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a381"></a>        <span class="src-key">if </span><span class="src-sym">(</span><span class="src-sym">!</span><span class="src-sym">(</span><span class="src-var">$result </span>= <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">))) </span><span class="src-sym">{</span></li>
<li><a name="a382"></a>            <span class="src-key">die </span><span class="src-sym">( </span><span class="src-str">'Error:' </span>. <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">error</span><span class="src-sym">(</span><span class="src-sym">) )</span><span class="src-sym">;</span></li>
<li><a name="a383"></a>        <span class="src-sym">}</span></li>
<li><a name="a384"></a>    <span class="src-sym">}</span></li>
<li><a name="a385"></a>    <span class="src-key">else </span><span class="src-sym">{ </span><span class="src-comm">// oh i like this **x story, lets put this on the frontpage ok :)</span></li>
<li><a name="a386"></a>                <span class="src-var">$sql </span>= <span class="src-str">&quot; insert into article_frontpage ( articleID , frontpage_sectionID ) &quot;</span><span class="src-sym">;</span></li>
<li><a name="a387"></a>        <span class="src-var">$sql </span>.= <span class="src-str">&quot; </span><span class="src-id">values</span>( '<span class="src-var">$articleID</span>', '<span class="src-var">$frontpage</span>' ) <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a388"></a>        <span class="src-key">if </span><span class="src-sym">(</span><span class="src-sym">!</span><span class="src-sym">(</span><span class="src-var">$result </span>= <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">))) </span><span class="src-sym">{</span></li>
<li><a name="a389"></a>            <span class="src-key">die </span><span class="src-sym">( </span><span class="src-str">'Error:' </span>. <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">error</span><span class="src-sym">(</span><span class="src-sym">) )</span><span class="src-sym">;</span></li>
<li><a name="a390"></a>        <span class="src-sym">}</span></li>
<li><a name="a391"></a>    <span class="src-sym">}</span></li>
<li><a name="a392"></a><span class="src-sym">}</span></li>
<li><a name="a393"></a>&nbsp;</li>
<li><a name="a394"></a><span class="src-key">if </span><span class="src-sym">( </span><span class="src-var">$articletask </span><span class="src-sym">) </span><span class="src-sym">{</span></li>
<li><a name="a395"></a>    <span class="src-var">$sql </span>= <span class="src-str">&quot;</span><span class="src-id">select</span> * <span class="src-id">from article_tasks where articleID</span> = '<span class="src-var">$articleID</span>' <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a396"></a>    <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a397"></a>    <span class="src-key">if </span><span class="src-sym">( </span><span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">getnumrows</span><span class="src-sym">(</span><span class="src-sym">) </span>&gt; <span class="src-num">0</span><span class="src-sym">) </span><span class="src-sym">{</span></li>
<li><a name="a398"></a>        <span class="src-var">$sql </span>= <span class="src-str">&quot; update article_tasks &quot;</span><span class="src-sym">;</span></li>
<li><a name="a399"></a>        <span class="src-var">$sql </span>.= <span class="src-str">&quot; </span><span class="src-id">set taskID</span> = '<span class="src-var">$articletask</span>' <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a400"></a>        <span class="src-var">$sql </span>.= <span class="src-str">&quot; where articleID=&quot; </span>. <a href="http://www.php.net/intval">intval</a><span class="src-sym">( </span><span class="src-var">$articleID </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a401"></a>        <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a402"></a>    <span class="src-sym">}</span></li>
<li><a name="a403"></a>    <span class="src-key">else</span><span class="src-sym">{</span></li>
<li><a name="a404"></a>        <span class="src-var">$sql </span>= <span class="src-str">&quot; insert into article_tasks ( articleID, taskID )&quot;</span><span class="src-sym">;</span></li>
<li><a name="a405"></a>        <span class="src-var">$sql </span>.= <span class="src-str">&quot; </span><span class="src-id">values</span>( '<span class="src-var">$articleID</span>', '<span class="src-var">$articletask</span>' )<span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a406"></a>        <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a407"></a>    <span class="src-sym">}</span></li>
<li><a name="a408"></a><span class="src-sym">}</span></li>
<li><a name="a409"></a>                                                   </li>
<li><a name="a410"></a><span class="src-comm">// if keywords was set by the editor</span></li>
<li><a name="a411"></a><span class="src-key">if</span><span class="src-sym">( </span><span class="src-var">$keywords </span><span class="src-sym">)</span><span class="src-sym">{</span></li>
<li><a name="a412"></a>    <span class="src-var">$sql </span>= <span class="src-str">&quot; select * from article_keywords ak &quot;</span><span class="src-sym">;</span></li>
<li><a name="a413"></a>    <span class="src-var">$sql </span>.= <span class="src-str">&quot; where ak.articleID=&quot; </span>. <a href="http://www.php.net/intval">intval</a><span class="src-sym">( </span><span class="src-var">$articleID </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a414"></a>    <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a415"></a>    <span class="src-key">if </span><span class="src-sym">( </span><span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">getnumrows</span><span class="src-sym">(</span><span class="src-sym">) </span>&gt; <span class="src-num">0</span><span class="src-sym">) </span><span class="src-sym">{</span></li>
<li><a name="a416"></a>        <span class="src-var">$sql </span>= <span class="src-str">&quot; update article_keywords &quot;</span><span class="src-sym">;</span></li>
<li><a name="a417"></a>        <span class="src-var">$sql </span>.= <span class="src-str">&quot; </span><span class="src-id">set keywords</span>= '<span class="src-var">$keywords</span>' <span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a418"></a>        <span class="src-var">$sql </span>.= <span class="src-str">&quot; where articleID=&quot; </span>. <a href="http://www.php.net/intval">intval</a><span class="src-sym">( </span><span class="src-var">$articleID </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a419"></a>        <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a420"></a>    <span class="src-sym">}</span></li>
<li><a name="a421"></a>    <span class="src-key">else</span><span class="src-sym">{</span></li>
<li><a name="a422"></a>        <span class="src-var">$sql </span>= <span class="src-str">&quot; insert into article_keywords ( articleID, keywords )&quot;</span><span class="src-sym">;</span></li>
<li><a name="a423"></a>        <span class="src-var">$sql </span>.= <span class="src-str">&quot; </span><span class="src-id">values</span>( '<span class="src-var">$articleID</span>', '<span class="src-var">$keywords</span>' )<span class="src-str">&quot;</span><span class="src-sym">;</span></li>
<li><a name="a424"></a>        <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a425"></a>    <span class="src-sym">}</span></li>
<li><a name="a426"></a><span class="src-sym">}</span></li>
<li><a name="a427"></a><span class="src-var">$sql </span>= <span class="src-str">&quot; select * from article_imgs ai&quot;</span><span class="src-sym">;</span></li>
<li><a name="a428"></a><span class="src-var">$sql </span>.= <span class="src-str">&quot; where ai.articleID=&quot; </span>. <a href="http://www.php.net/intval">intval</a><span class="src-sym">( </span><span class="src-var">$articleID </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a429"></a><span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a430"></a><span class="src-var">$result </span>= <span class="src-key">array</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a431"></a><span class="src-key">while</span><span class="src-sym">( </span><span class="src-var">$row </span>= <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">fetcharray</span><span class="src-sym">(</span><span class="src-sym">)) </span><span class="src-var">$imagesets</span><span class="src-sym">[</span><span class="src-sym">] </span>= <span class="src-var">$row</span><span class="src-sym">;</span></li>
<li><a name="a432"></a><span class="src-key">if </span><span class="src-sym">(</span><span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">getnumrows</span><span class="src-sym">(</span><span class="src-sym">) </span>&gt; <span class="src-num">0</span><span class="src-sym">)</span><span class="src-sym">{</span></li>
<li><a name="a433"></a>    <span class="src-key">for</span><span class="src-sym">( </span><span class="src-var">$i</span>=<span class="src-num">0</span><span class="src-sym">; </span><span class="src-var">$i</span>&lt;<a href="http://www.php.net/count">count</a><span class="src-sym">(</span><span class="src-var">$imagesets</span><span class="src-sym">)</span><span class="src-sym">; </span><span class="src-var">$i</span>++ <span class="src-sym">)</span><span class="src-sym">{</span></li>
<li><a name="a434"></a>        <span class="src-key">foreach</span><span class="src-sym">( </span><span class="src-var">$imagesets </span><span class="src-key">as </span><span class="src-var">$field</span>=&gt;<span class="src-var">$value </span><span class="src-sym">)</span><span class="src-sym">{</span></li>
<li><a name="a435"></a>            <span class="src-key">if</span><span class="src-sym">( </span><span class="src-var">$field </span>== <span class="src-str">'articleID' </span><span class="src-sym">)</span><span class="src-sym">{            </span></li>
<li><a name="a436"></a>                <span class="src-var">$sql </span>= <span class="src-str">&quot; update article_imgs &quot;</span><span class="src-sym">;</span></li>
<li><a name="a437"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot; set show_image='0' &quot;</span><span class="src-sym">;</span><span class="src-comm">// reset show-image to 0     </span></li>
<li><a name="a438"></a>                                <span class="src-var">$sql </span>.= <span class="src-str">&quot; where imageID=&quot; </span>. <span class="src-var">$imagesets</span><span class="src-sym">[</span><span class="src-var">$i</span><span class="src-sym">]</span><span class="src-sym">-&gt;</span><span class="src-id">imageID</span><span class="src-sym">;</span></li>
<li><a name="a439"></a>                <span class="src-var">$sql </span>.= <span class="src-str">&quot; and articleID=&quot; </span>. <a href="http://www.php.net/intval">intval</a><span class="src-sym">( </span><span class="src-var">$articleID </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a440"></a>                <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a441"></a>            <span class="src-sym">}    </span></li>
<li><a name="a442"></a>        <span class="src-sym">}    </span></li>
<li><a name="a443"></a>    <span class="src-sym">}    </span></li>
<li><a name="a444"></a><span class="src-sym">}</span></li>
<li><a name="a445"></a><span class="src-comm">// if images was set by the news editor ( nash nice smyle )</span></li>
<li><a name="a446"></a><span class="src-key">if </span><span class="src-sym">( </span><span class="src-var">$article_images </span><span class="src-sym">)</span><span class="src-sym">{</span></li>
<li><a name="a447"></a>    <span class="src-key">if </span><span class="src-sym">(</span><a href="http://www.php.net/is_array">is_array</a><span class="src-sym">( </span><span class="src-var">$article_images </span><span class="src-sym">)) </span><span class="src-sym">{</span></li>
<li><a name="a448"></a>        <span class="src-key">foreach</span><span class="src-sym">( </span><span class="src-var">$article_images </span><span class="src-key">as </span><span class="src-var">$indx </span>=&gt; <span class="src-var">$imgID </span><span class="src-sym">)</span><span class="src-sym">{</span></li>
<li><a name="a449"></a>            <span class="src-var">$sql </span>= <span class="src-str">&quot; update article_imgs &quot;</span><span class="src-sym">;</span></li>
<li><a name="a450"></a>            <span class="src-var">$sql </span>.= <span class="src-str">&quot; set show_image='1' &quot;</span><span class="src-sym">;</span></li>
<li><a name="a451"></a>            <span class="src-var">$sql </span>.= <span class="src-str">&quot; where imageID=&quot; </span>. <span class="src-var">$imgID</span><span class="src-sym">;</span></li>
<li><a name="a452"></a>            <span class="src-var">$sql </span>.= <span class="src-str">&quot; and articleID=&quot; </span>. <a href="http://www.php.net/intval">intval</a><span class="src-sym">( </span><span class="src-var">$articleID </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a453"></a>            <span class="src-var">$db</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">( </span><span class="src-var">$sql </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a454"></a>        <span class="src-sym">}</span></li>
<li><a name="a455"></a>    <span class="src-sym">}</span></li>
<li><a name="a456"></a><span class="src-sym">}</span></li>
<li><a name="a457"></a><span class="src-comm">// after done saving,, jump to his parent page...</span></li>
<li><a name="a458"></a><a href="http://www.php.net/header">header</a><span class="src-sym">( </span><span class="src-str">'Location: ' </span>. <span class="src-var">$gotoURL </span><span class="src-sym">)</span><span class="src-sym">;</span></li>
<li><a name="a459"></a>&nbsp;</li>
<li><a name="a460"></a><span class="src-php">?&gt;</span></li>
</ol></pre>
</div>
	<p class="notes" id="credit">
		Documentation generated on Wed,  5 Apr 2006 20:09:48 -0700 by <a href="http://www.phpdoc.org" target="_blank">phpDocumentor 1.3.0RC4</a>
	</p>
	</body>
</html>